<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuarios - ProFutbol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1), 0 5px 15px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 450px;
        }
        .input-field {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #10b981; /* Green-500 */
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body>
    <div class="card">
        <h2 class="text-3xl font-extrabold text-green-700 mb-2 text-center">¡Únete a ProFutbol!</h2>
        <p class="mb-6 text-gray-600 text-center">Crea tu cuenta para empezar a reservar canchas.</p>

        <form id="registroForm">
            <div id="message" class="mb-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

            <div class="mb-4">
                <label for="regNombre" class="block text-sm font-semibold text-gray-700 mb-1">Nombre</label>
                <input type="text" id="regNombre" required class="input-field block w-full" placeholder="Tu nombre">
            </div>

            <div class="mb-4">
                <label for="regApellido" class="block text-sm font-semibold text-gray-700 mb-1">Apellido</label>
                <input type="text" id="regApellido" required class="input-field block w-full" placeholder="Tu apellido">
            </div>

            <div class="mb-4">
                <label for="regEmail" class="block text-sm font-semibold text-gray-700 mb-1">Correo Electrónico</label>
                <input type="email" id="regEmail" required class="input-field block w-full" placeholder="ejemplo@correo.com">
            </div>

            <div class="mb-6">
                <label for="regPassword" class="block text-sm font-semibold text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="regPassword" required class="input-field block w-full" placeholder="Mínimo 6 caracteres">
            </div>

            <button type="submit" id="btnRegistro" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                Crear Cuenta
            </button>
        </form>

        <p class="mt-6 text-center text-sm">
            ¿Ya tienes cuenta? <a href="login.html" class="text-green-600 hover:text-green-800 font-bold">Inicia Sesión aquí.</a>
        </p>
    </div>

    <script type="module">
        // --- 1. IMPORTACIONES ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. CONSTANTES GLOBALES Y CONFIGURACIÓN ---
        const FIREBASE_CONFIG = {
            // Utiliza la configuración del login.html para la consistencia
            apiKey: "AIzaSyAWCPbrKbfVNieWdjIWOmsr27sqAWzEefk", 
            authDomain: "profutbolapp.firebaseapp.com",
            projectId: "profutbolapp",
            storageBucket: "profutbolapp.firebasestorage.app",
            messagingSenderId: "187277252854",
            appId: "1:187277252854:web:73d371c14b28f764de74d7"
        };
        const LOGIN_PAGE = 'login.html';
        const DB_ID = 'base1reservas'; // ID de la base de datos secundaria (según manual técnico)

        // --- 3. INICIALIZACIÓN DE FIREBASE ---
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app, DB_ID); // Conecta a la BD secundaria

        // --- 4. REFERENCIAS DEL DOM ---
        const registroForm = document.getElementById('registroForm');
        const messageBox = document.getElementById('message');
        const btnRegistro = document.getElementById('btnRegistro');

        // --- 5. FUNCIÓN AUXILIAR PARA MENSAJES ---
        function showMessage(text, isError) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        }

        // --- 6. MANEJADOR DEL REGISTRO ---
        registroForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nombre = document.getElementById('regNombre').value.trim();
            const apellido = document.getElementById('regApellido').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            if (password.length < 6) {
                showMessage("La contraseña debe tener al menos 6 caracteres.", true);
                return;
            }

            btnRegistro.disabled = true;
            btnRegistro.textContent = 'Registrando...';
            showMessage("Creando tu cuenta...", false);

            try {
                // Paso 1: Crear el usuario en Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Paso 2: Crear el documento de perfil en Firestore (¡Asignando el rol de 'usuario'!)
                const userRef = doc(db, "usuarios", user.uid);
                await setDoc(userRef, {
                    nombre: nombre,
                    apellido: apellido,
                    email: user.email,
                    rol: 'usuario', // <<-- ESTO ASEGURA QUE NO SEA ADMIN
                    fecha_registro: serverTimestamp()
                });
                
                showMessage("¡Registro exitoso! Serás redirigido en breve.", false);
                
                // Redirigir al login para que inicie sesión con su nueva cuenta
                setTimeout(() => {
                    window.location.href = LOGIN_PAGE;
                }, 2000);

            } catch (error) {
                console.error("Error al registrar el usuario:", error);
                
                let errorMessage = "Ocurrió un error desconocido. Intenta más tarde.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este correo electrónico ya está registrado.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña es demasiado débil.';
                }
                
                showMessage(`Error: ${errorMessage}`, true);
                btnRegistro.disabled = false;
                btnRegistro.textContent = 'Crear Cuenta';
            }
        });
    </script>
</body>
</html>
