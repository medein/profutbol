<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Reservas - ProFutbol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css"> 
    <style>
        /* Estilo para la lista de búsqueda de clientes */
        .search-container {
            position: relative;
        }
    </style>
</head>
<body>
    
    <div class="container mx-auto p-4">
        <header class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
            <h1 class="text-3xl font-bold text-blue-700">Gestión de Reservas</h1>
            <div class="flex items-center">
                 <a href="index.html" class="mr-4 text-gray-600 hover:text-gray-900 font-semibold transition">
                    ← Volver a Canchas
                </a>
                <button id="btnLogout" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded transition">
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <div id="contentReservas">
            <div class="bg-white p-6 rounded-lg shadow-xl mb-6">
                <h2 class="text-xl font-semibold mb-4" id="formTitleReserva">Crear Nueva Reserva</h2>
                <form id="reservaForm">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="search-container">
                            <label for="reservaClienteNombre" class="block text-sm font-medium text-gray-700">Buscar Cliente (Nombre)</label>
                            <input type="text" id="reservaClienteNombre" class="mt-1 block w-full border border-gray-300 rounded-md p-2" placeholder="Escribe el nombre del cliente">
                            <div id="searchResults" class="absolute z-10 bg-white border border-gray-300 w-full mt-1 max-h-40 overflow-y-auto shadow-lg hidden">
                            </div>
                            <input type="hidden" id="reservaUserId"> 
                            <input type="hidden" id="reservaUserEmail"> 
                        </div>

                        <div>
                            <label for="reservaCanchaSelect" class="block text-sm font-medium text-gray-700">Seleccionar Cancha</label>
                            <select id="reservaCanchaSelect" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                <option value="">Cargando Canchas...</option>
                            </select>
                        </div>

                        <div>
                            <label for="reservaFechaHora" class="block text-sm font-medium text-gray-700">Fecha y Hora</label>
                            <input type="datetime-local" id="reservaFechaHora" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                        </div>

                        <div>
                             <label for="reservaEstado" class="block text-sm font-medium text-gray-700">Estado</label>
                             <select id="reservaEstado" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
                                 <option value="pagado">Pagado</option>
                                 <option value="pendiente">Pendiente</option>
                                 <option value="cancelada">Cancelada</option>
                             </select>
                        </div>
                    </div>

                    <input type="hidden" id="reservaId">
                    <div class="mt-6">
                        <button type="submit" id="btnSubmitFormReserva" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded transition">
                            Guardar Reserva
                        </button>
                        <button type="button" id="btnCancelEditReserva" class="ml-2 text-gray-600 hover:text-gray-800 hidden">
                            Cancelar Edición
                        </button>
                    </div>
                </form>
            </div>


            <div class="bg-white p-6 rounded-lg shadow-xl mb-6">
                <h2 class="text-xl font-semibold mb-4">Actividad de Clientes (Reservas por Email)</h2>
                <canvas id="reservasChart" width="400" height="150"></canvas>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold mb-4">Detalle de Todas las Reservas</h2>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cancha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario (Email)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora Reserva</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Creación</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reservasList" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. IMPORTACIONES ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            where,
            getDocs, 
            getDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. CONFIGURACIÓN ---
        const firebaseConfig = {
            // Reemplaza con tus datos reales de configuración de Firebase
            apiKey: "AIzaSyAWCPbrKbfVNieWdjIWOmsr27sqAWzEefk", 
            authDomain: "profutbolapp.firebaseapp.com",
            projectId: "profutbolapp",
            storageBucket: "profutbolapp.firebasestorage.app",
            messagingSenderId: "187277252854",
            appId: "1:187277252854:web:73d371c14b28f764de74d7"
        };
        
        const LOGIN_PAGE = 'login.html'; 
        const PUBLIC_COLLECTION_PATH = 'canchas';
        const RESERVAS_COLLECTION_PATH = 'reservas';
        const USUARIOS_COLLECTION_PATH = 'usuarios'; 
        
        let auth;
        let db;
        let chartInstance = null;
        let allReservas = []; 
        let allCanchas = []; 
        let userCache = {}; // Cache para guardar emails de usuarios

        // Elementos del DOM - RESERVAS 
        const btnLogout = document.getElementById('btnLogout'); 
        const reservasList = document.getElementById('reservasList');
        const reservasChartContext = document.getElementById('reservasChart').getContext('2d');
        const reservaForm = document.getElementById('reservaForm');
        const inputReservaId = document.getElementById('reservaId');
        const inputReservaFechaHora = document.getElementById('reservaFechaHora');
        const selectReservaEstado = document.getElementById('reservaEstado');
        const formTitleReserva = document.getElementById('formTitleReserva');
        const btnCancelEditReserva = document.getElementById('btnCancelEditReserva');
        
        // Elementos de Búsqueda y Selección
        const inputReservaClienteNombre = document.getElementById('reservaClienteNombre');
        const searchResults = document.getElementById('searchResults');
        const inputReservaUserId = document.getElementById('reservaUserId');
        const inputReservaUserEmail = document.getElementById('reservaUserEmail');
        const selectReservaCancha = document.getElementById('reservaCanchaSelect');
        
        function showMessage(text, colorClass) {
            console.log(text, colorClass);
        }

        // --- FUNCIONES DE FIRESTORE: CANCHAS (Solo para llenar el selector) ---
        function fillCanchaSelector(canchas) {
            selectReservaCancha.innerHTML = '<option value="">-- Seleccione una cancha --</option>';
            canchas.forEach(cancha => {
                const option = document.createElement('option');
                option.value = cancha.nombre; 
                option.textContent = cancha.nombre; 
                selectReservaCancha.appendChild(option);
            });
            allCanchas = canchas;
        }

        function startCanchasLoader() {
            try {
                const q = query(collection(db, PUBLIC_COLLECTION_PATH));
                onSnapshot(q, (snapshot) => {
                    let canchas = [];
                    snapshot.forEach((doc) => {
                        canchas.push({ id: doc.id, ...doc.data() });
                    });
                    fillCanchaSelector(canchas);
                });
            } catch (error) {
                console.error("Error al iniciar el loader de canchas:", error);
            }
        }
        
        // --- 3. LÓGICA DE BÚSQUEDA DE CLIENTES (USUARIOS) ---

        async function searchClients(queryText) {
            searchResults.innerHTML = '';
            
            if (queryText.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }

            try {
                const start = queryText;
                const end = queryText + '\uf8ff'; 

                const q = query(
                    collection(db, USUARIOS_COLLECTION_PATH),
                    where('nombre', '>=', start),
                    where('nombre', '<=', end)
                );

                const snapshot = await getDocs(q); 
                
                if (snapshot.empty) {
                    searchResults.innerHTML = '<div class="p-2 text-gray-500">No se encontraron clientes.</div>';
                    searchResults.classList.remove('hidden');
                    return;
                }

                snapshot.forEach(doc => {
                    const client = doc.data();
                    const resultItem = document.createElement('div');
                    resultItem.className = 'p-2 cursor-pointer hover:bg-gray-100 text-sm';
                    resultItem.textContent = `${client.nombre} ${client.apellido} (${client.email})`;
                    
                    resultItem.addEventListener('click', () => selectClient(client, doc.id));
                    searchResults.appendChild(resultItem);
                });

                searchResults.classList.remove('hidden');

            } catch (error) {
                console.error("Error buscando clientes:", error);
            }
        }

        function selectClient(client, uid) {
            inputReservaClienteNombre.value = `${client.nombre} ${client.apellido}`; 
            inputReservaUserId.value = uid;
            inputReservaUserEmail.value = client.email;
            searchResults.classList.add('hidden'); 
        }

        document.addEventListener('click', (e) => {
            if (e.target !== inputReservaClienteNombre && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });
        
        inputReservaClienteNombre.addEventListener('input', (e) => searchClients(e.target.value));

        // --- 4. FUNCIONES DE FIRESTORE: RESERVAS ---
        // ... (Todas las funciones de Reservas, enriquecimiento, formatDate, etc., que ya tenías)
        // [Las he mantenido en el script para no hacerlo excesivamente largo, solo reorganicé el orden]

        function formatDate(timestamp) {
            const options = { 
                year: 'numeric', month: 'short', day: 'numeric', 
                hour: '2-digit', minute: '2-digit' 
            };
            
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString('es-GT', options);
            }
            return 'N/A';
        }

        function formatTimestampToInput(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                return '';
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        async function fetchUserEmailByUID(uid) {
            if (userCache[uid]) {
                return userCache[uid];
            }
            try {
                const userRef = doc(db, USUARIOS_COLLECTION_PATH, uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    userCache[uid] = userData.email || 'Email No Encontrado'; 
                    return userCache[uid];
                } else {
                    userCache[uid] = 'Usuario Eliminado';
                    return 'Usuario Eliminado';
                }
            } catch (error) {
                console.error("Error al buscar usuario por UID:", uid, error);
                userCache[uid] = 'Error de Búsqueda';
                return 'Error de Búsqueda';
            }
        }
        
        async function enrichReservasWithUserData(reservas) {
            const promises = reservas.map(async (reserva) => {
                if (reserva.userEmail) {
                    return reserva;
                }

                if (reserva.id_usuario) {
                    reserva.userEmail = await fetchUserEmailByUID(reserva.id_usuario);
                }
                return reserva;
            });

            return Promise.all(promises);
        }

        async function handleAddEditReserva(e) {
            e.preventDefault();
            const id = inputReservaId.value;
            const isEditing = !!id;
            
            if (!inputReservaUserEmail.value && !isEditing) {
                showMessage("Debes seleccionar un cliente válido de la lista de búsqueda para crear una reserva.", 'bg-red-500');
                return;
            }
            
            if (!selectReservaCancha.value) {
                showMessage("Debes seleccionar una cancha.", 'bg-red-500');
                return;
            }

            const dateInput = inputReservaFechaHora.value;
            const dateObj = new Date(dateInput);
            
            const reservaData = {
                id_usuario: inputReservaUserId.value,       
                id_cancha: selectReservaCancha.value,       
                estado_pago: selectReservaEstado.value,     
                fecha_reserva: dateObj,                     
                userEmail: inputReservaUserEmail.value,     
                userName: inputReservaClienteNombre.value,  
                fechaCreacion: isEditing ? (allReservas.find(r => r.id === id)?.fechaCreacion) : serverTimestamp()
            };

            try {
                if (isEditing) {
                    const reservaRef = doc(db, RESERVAS_COLLECTION_PATH, id);
                    await updateDoc(reservaRef, reservaData);
                    showMessage("Reserva actualizada con éxito.", 'bg-green-500');
                } else {
                    await addDoc(collection(db, RESERVAS_COLLECTION_PATH), reservaData);
                    showMessage("Nueva reserva creada con éxito.", 'bg-green-500');
                }
                
                reservaForm.reset();
                inputReservaId.value = '';
                inputReservaUserId.value = '';
                inputReservaUserEmail.value = '';
                inputReservaClienteNombre.value = '';
                formTitleReserva.textContent = 'Crear Nueva Reserva';
                btnCancelEditReserva.classList.add('hidden');

            } catch (error) {
                console.error("Error al guardar reserva:", error);
                showMessage(`Error al guardar reserva: ${error.message}`, 'bg-red-500');
            }
        }
        
        function handleEditReserva(e) {
            const reservaId = e.currentTarget.dataset.id;
            const reserva = allReservas.find(r => r.id === reservaId);

            if (reserva) {
                inputReservaClienteNombre.value = reserva.userName || '';
                inputReservaUserId.value = reserva.id_usuario || ''; 
                inputReservaUserEmail.value = reserva.userEmail || '';
                
                inputReservaId.value = reserva.id;
                selectReservaCancha.value = reserva.id_cancha || ''; 
                selectReservaEstado.value = reserva.estado_pago || 'pagado'; 
                inputReservaFechaHora.value = formatTimestampToInput(reserva.fecha_reserva); 
                
                formTitleReserva.textContent = `Editar Reserva: ${reserva.id.substring(0, 4)}...`;
                btnCancelEditReserva.classList.remove('hidden');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        async function handleDeleteReserva(e) {
            const reservaId = e.currentTarget.dataset.id;
            
            if (confirm(`¿Estás seguro de que quieres eliminar la reserva ${reservaId}?`)) {
                try {
                    const reservaRef = doc(db, RESERVAS_COLLECTION_PATH, reservaId);
                    await deleteDoc(reservaRef);
                    showMessage("Reserva eliminada con éxito.", 'bg-green-500');
                } catch (error) {
                    console.error("Error al eliminar la reserva:", error);
                    showMessage("Error al eliminar la reserva.", 'bg-red-500');
                }
            }
        }

        function startReservasListener() {
            try {
                const q = query(collection(db, RESERVAS_COLLECTION_PATH));

                onSnapshot(q, async (snapshot) => { 
                    allReservas = []; 
                    let userActivity = {};

                    snapshot.forEach((doc) => {
                        const reserva = { id: doc.id, ...doc.data() };
                        allReservas.push(reserva);
                    });
                    
                    const enrichedReservas = await enrichReservasWithUserData(allReservas);

                    enrichedReservas.forEach(reserva => {
                        const userEmail = reserva.userEmail || 'Sin Email'; 
                        userActivity[userEmail] = (userActivity[userEmail] || 0) + 1;
                    });

                    displayReservas(enrichedReservas);
                    updateChart(userActivity);
                });
            } catch (error) {
                console.error("Error al iniciar el listener de reservas:", error);
            }
        }

        function displayReservas(reservas) {
            reservasList.innerHTML = '';
            
            reservas.forEach(reserva => {
                const row = document.createElement('tr');
                
                const fechaReserva = formatDate(reserva.fecha_reserva);
                const fechaCreacion = formatDate(reserva.fechaCreacion);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${reserva.id_cancha || 'N/A'}</td>      
                    <td class="px-6 py-4 whitespace-nowrap">${reserva.userEmail || 'N/A'}</td>     
                    <td class="px-6 py-4 whitespace-nowrap">${fechaReserva}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${fechaCreacion}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${reserva.estado_pago || 'Confirmada'}</td> 
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button data-id="${reserva.id}" class="btn-edit-reserva text-indigo-600 hover:text-indigo-900 mr-3">Editar</button>
                        <button data-id="${reserva.id}" class="btn-delete-reserva text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                reservasList.appendChild(row);
            });

            document.querySelectorAll('.btn-edit-reserva').forEach(btn => btn.addEventListener('click', handleEditReserva));
            document.querySelectorAll('.btn-delete-reserva').forEach(btn => btn.addEventListener('click', handleDeleteReserva));
        }


        function updateChart(userActivity) {
            const labels = Object.keys(userActivity);
            const data = Object.values(userActivity);
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(reservasChartContext, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reservas Realizadas',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // --- FUNCIÓN CRÍTICA PARA CHEQUEAR EL ROL DE ADMINISTRADOR ---
        async function getUserRole(uid) {
            try {
                const userRef = doc(db, USUARIOS_COLLECTION_PATH, uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    return userSnap.data().rol; 
                }
                return null;
            } catch (error) {
                console.error("Error al obtener rol del usuario:", error);
                return null;
            }
        }

        // --- 5. INICIALIZACIÓN Y SEGURIDAD ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                // Conexión a la base de datos secundaria (base1reservas)
                db = getFirestore(app, 'base1reservas');

                onAuthStateChanged(auth, async (user) => { 
                    if (!user) {
                        window.location.href = LOGIN_PAGE; 
                    } else {
                        const userRole = await getUserRole(user.uid);
                        
                        if (userRole === 'admin') {
                            // Acceso permitido: Inicia listeners y el panel
                            startCanchasLoader(); // Solo carga las canchas para el selector
                            startReservasListener();
                        } else {
                            // Acceso DENEGADO
                            await signOut(auth);
                            alert("Acceso denegado. Solo administradores pueden ingresar a este panel.");
                            window.location.href = LOGIN_PAGE; 
                        }
                    }
                });

            } catch (error) {
                console.error("Error fatal al inicializar Firebase:", error);
            }
        }

        // --- 6. MANEJO DE CIERRE DE SESIÓN Y SUBMITS ---
        if (btnLogout) {
            btnLogout.addEventListener('click', async () => {
                try { 
                    await signOut(auth);
                    window.location.href = LOGIN_PAGE;
                } catch (error) { 
                    console.error("Error al cerrar sesión:", error); 
                }
            });
        }
        
        // Listeners del Formulario de Reservas
        reservaForm.addEventListener('submit', handleAddEditReserva);
        btnCancelEditReserva.addEventListener('click', () => {
            reservaForm.reset();
            inputReservaId.value = '';
            inputReservaUserId.value = '';
            inputReservaUserEmail.value = '';
            inputReservaClienteNombre.value = '';
            formTitleReserva.textContent = 'Crear Nueva Reserva';
            btnCancelEditReserva.classList.add('hidden');
        });

        initializeFirebase();
    </script>
</body>
</html>